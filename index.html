<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>3D with WebGL</title>
    <style>
    body{
        margin: 0px;
        background-color: #000000;
        overflow: hidden;
    }
    </style>
</head>
<body>
    <div id="container"></div>
    <script src="JS/three.min.js"></script>
    <script src="JS/physi.js"></script>
    <script src="js/TrackballControls.js"></script>
    <script>
        Physijs.scripts.worker = 'JS/physijs_worker.js';
        Physijs.scripts.ammo = 'ammo.js';
        var camera, controls, silla, silla_material, scene, renderer, ground_material, ground, setMousePosition, object, mouse_position;
        
        init = function (){
            var container = document.getElementById('container');
            camera = new THREE.PerspectiveCamera(
                45,
                window.innerWidth / window.innerHeight,
                1,
                1000
            );


            scene = new Physijs.Scene();
            scene.setGravity(new THREE.Vector3(0, -30, 0));
            scene.addEventListener(
                'update',
                function(){
                    //applyForce();
                    controls.update();
                    scene.simulate(undefined, 1);
                }
            );
            
            
            var light;
            var ambientLight = new THREE.AmbientLight(0xcccccc, 0.4);
            scene.add(ambientLight);

            var material = new THREE.MeshBasicMaterial({
                color: 0xffaa00,
                wireframe: true
            });


           
            
            
            renderer = new THREE.WebGLRenderer({
                antialias: true
            });

            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.setSize(window.innerWidth, window.innerHeight);

            container.appendChild(renderer.domElement);

            controls = new THREE.TrackballControls(camera, container);
            controls.rotateSpeed = 4.0;
            controls.zoomSpeed = 4.2;
            controls.panSpeed = 4.8;

            controls.noZoom = false;
            controls.noPan = false;
            
            controls.staticMoving = true;
            controls.dynamicDampingFactor = 0.3;

            controls.key = [65, 83, 68];
            
            camera.position.set(60, 50, 60);
            camera.lookAt(scene.position);
            scene.add(camera);

            ground_material = Physijs.createMaterial(
                new THREE.MeshLambertMaterial({
                    map: new THREE.TextureLoader().load('TEXTURES/floor.jpg')
                }),
                0.8, //Friccion
                0.4 //Restitucion
            );

            ground_material.map.wrapS = ground_material.map.wrapT = THREE.RepeatWrapping;
            ground_material.map.repeat.set(3, 3);

            silla_material = new Physijs.createMaterial(
                new THREE.MeshLambertMaterial({
                    map: new THREE.TextureLoader().load('TEXTURES/madera.jpg'),
                }),
                .6,
                .2
            );
            silla_material.map.wrapS = silla_material.map.wrapT = THREE.RepeatWrapping;
            silla_material.map.repeat.set(0.25, 0.25);
                
            ground = new Physijs.BoxMesh(
                new THREE.BoxGeometry(400, 2, 400),
                ground_material,
                0
            );

            ground.receiveShadow = true;
            scene.add(ground);

            construirSilla();

           
            requestAnimationFrame(render);
            scene.simulate();
           
        }



        function render(){
            requestAnimationFrame(render);
            renderer.render(scene, camera);
        };

        construirSilla = (function(){
            var construirRespaldo, construirPatas, esamblar;

            construirRespaldo = function(){
                var respaldo, objeto;

                respaldo = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(5, 1, 0.5),
                    silla_material
                );

                respaldo.position.y = 5;
                respaldo.position.z = -2.5;
                respaldo.castShadow = true;
                respaldo.receiveShadow = true;

                objeto = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(1, 5, 0.5),
                    silla_material
                );

                objeto.position.y = -3;
                objeto.position.x = -2;
                objeto.castShadow = true;
                objeto.receiveShadow= true;
                respaldo.add(objeto);
                
                objeto = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(1, 5, 0.5),
                    silla_material
                );

                objeto.position.y = -3;
                objeto.position.x = 2;
                objeto.castShadow = true;
                objeto.receiveShadow = true;
                respaldo.add(objeto);

                objeto = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(1, 5, 0.5),
                    silla_material
                );

                objeto.position.y = -3;
                objeto.position.x = 0;
                objeto.castShadow = true;
                objeto.receiveShadow = true;
                respaldo.add(objeto);

                return respaldo;
            };

            construirPatas = function(){
                var pata, _pata;

                //atras izquierda
                pata = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(0.5, 4, 0.5),
                    silla_material
                );
                pata.position.x = 2.25;
                pata.position.z = -2.25;
                pata.position.y = -2.5;
                pata.castShadow= true;
                pata.receiveShadow = true;

                //atras derecha
                _pata = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(0.5, 4, 0.5),
                    silla_material
                );
                _pata.position.x = -4.5;
                _pata.castShadow = true;
                _pata.receiveShadow = true;
                pata.add(_pata);

                //enfrente izqueirda
                _pata = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(0.5, 4, 0.5),
                    silla_material
                );

                _pata.position.z = 4.5;
                _pata.castShadow = true;
                _pata.receiveShadow = true;
                pata.add(_pata);

                //enfrente derecha
                _pata = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(0.5, 4, 0.5),
                    silla_material
                );

                _pata.position.x = -4.5;
                _pata.position.z = 4.5;
                _pata.castShadow = true;
                _pata.receiveShadow = true;
                pata.add(_pata);

                return pata;
            }

            ensamblar = function(){
                var silla, respaldo, patas;

                //asiento
                silla = new Physijs.BoxMesh(
                    new THREE.BoxGeometry(5, 1, 5),
                    silla_material
                );
                silla.castShadow = true;
                silla.receiveShadow = true;

                //respaldo
                respaldo = construirRespaldo();
                silla.add(respaldo);

                patas = construirPatas();
                silla.add(patas);

                //Coloca la silla;
                silla.position.y = Math.random() * 50 - 25;
                silla.position.x = Math.random() * 50 - 25;
                silla.position.z = Math.random() * 50 - 25;
                scene.add(silla);
                
            }

            return ensamblar;
        })();

        
        window.onload = init;
    </script>
</body>
</html>